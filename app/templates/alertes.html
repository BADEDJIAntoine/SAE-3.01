{% extends 'layout.html' %}

{% block content %}
<!-- Hero Section -->
<div class="alertes-hero">
  <div class="container">
    <h1><i class="bi bi-bell-fill"></i> Gestion des Alertes</h1>
    <p>Supervision et traitement des incidents en temps réel</p>
  </div>
</div>

<!-- Contenu principal -->
<div class="container mt-4 pb-5">
  
  <!-- Actions principales -->
  <div class="alertes-actions mb-4">
    <a href="{{ url_for('index') }}" class="btn btn-rythmo-back">
      <i class="bi bi-arrow-left"></i> Retour au tableau de bord
    </a>
    <div class="alertes-badge-critical" id="criticalBadge" style="display: none;">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <span id="criticalCount">0</span> incidents critiques
    </div>
  </div>

  <!-- Statistiques -->
  <div class="alertes-stats mb-4">
    <div class="stat-card-alerte">
      <div class="stat-icon-alerte stat-icon-total">
        <i class="bi bi-list-ul"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">Total incidents</div>
      </div>
    </div>
    <div class="stat-card-alerte">
      <div class="stat-icon-alerte stat-icon-open">
        <i class="bi bi-circle-fill"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.ouverts }}</div>
        <div class="stat-label">Ouverts</div>
      </div>
    </div>
    <div class="stat-card-alerte">
      <div class="stat-icon-alerte stat-icon-progress">
        <i class="bi bi-arrow-repeat"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.en_cours }}</div>
        <div class="stat-label">En cours</div>
      </div>
    </div>
    <div class="stat-card-alerte">
      <div class="stat-icon-alerte stat-icon-resolved">
        <i class="bi bi-check-circle-fill"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.resolus }}</div>
        <div class="stat-label">Résolus</div>
      </div>
    </div>
    <div class="stat-card-alerte stat-card-critical">
      <div class="stat-icon-alerte stat-icon-critical">
        <i class="bi bi-exclamation-triangle-fill"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.critiques }}</div>
        <div class="stat-label">Critiques</div>
      </div>
    </div>
  </div>

  <!-- Filtres -->
  <div class="alertes-filters mb-4">
    <div class="filter-group">
      <label class="filter-label">
        <i class="bi bi-funnel"></i> État
      </label>
      <select class="filter-select" id="filterEtat">
        <option value="tous" {% if request.args.get('etat') == 'tous' or not request.args.get('etat') %}selected{% endif %}>Tous</option>
        <option value="ouvert" {% if request.args.get('etat') == 'ouvert' %}selected{% endif %}>Ouverts</option>
        <option value="en_cours" {% if request.args.get('etat') == 'en_cours' %}selected{% endif %}>En cours</option>
        <option value="resolu" {% if request.args.get('etat') == 'resolu' %}selected{% endif %}>Résolus</option>
        <option value="ignore" {% if request.args.get('etat') == 'ignore' %}selected{% endif %}>Ignorés</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">
        <i class="bi bi-tag"></i> Type
      </label>
      <select class="filter-select" id="filterType">
        <option value="tous" {% if request.args.get('type') == 'tous' or not request.args.get('type') %}selected{% endif %}>Tous</option>
        {% for type_key, type_info in incident_types.items() %}
        <option value="{{ type_key }}" {% if request.args.get('type') == type_key %}selected{% endif %}>{{ type_info.nom }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">
        <i class="bi bi-flag-fill"></i> Gravité
      </label>
      <select class="filter-select" id="filterGravite">
        <option value="tous" {% if request.args.get('gravite') == 'tous' or not request.args.get('gravite') %}selected{% endif %}>Toutes</option>
        {% for grav_key, grav_info in gravites.items() %}
        <option value="{{ grav_key }}" {% if request.args.get('gravite') == grav_key %}selected{% endif %}>{{ grav_info.nom }}</option>
        {% endfor %}
      </select>
    </div>
    <button class="btn-filter-reset" onclick="resetFilters()">
      <i class="bi bi-x-circle"></i> Réinitialiser
    </button>
  </div>

  <!-- Liste des incidents -->
  <div class="incidents-list">
    {% if incidents %}
      {% for incident in incidents %}
        <div class="incident-card incident-{{ incident.etat }} incident-gravite-{{ incident.gravite }}" 
             data-etat="{{ incident.etat }}" 
             data-type="{{ incident.type }}" 
             data-gravite="{{ incident.gravite }}">
          
          <!-- En-tête -->
          <div class="incident-header">
            <div class="incident-header-left">
              <div class="incident-type-icon" style="color: {{ incident_types[incident.type].couleur }}">
                <i class="bi {{ incident_types[incident.type].icone }}"></i>
              </div>
              <div class="incident-main-info">
                <h3 class="incident-titre">{{ incident.titre }}</h3>
                <div class="incident-meta">
                  <span class="incident-type">{{ incident_types[incident.type].nom }}</span>
                  <span class="meta-separator">•</span>
                  <span class="incident-zone">
                    <i class="bi bi-geo-alt"></i> {{ incident.zone_impactee }}
                  </span>
                  <span class="meta-separator">•</span>
                  <span class="incident-date">
                    <i class="bi bi-clock"></i> {{ incident.debut.strftime('%d/%m/%Y %H:%M') if incident.debut else 'N/A' }}
                  </span>
                </div>
              </div>
            </div>
            <div class="incident-header-right">
              <div class="incident-gravite-badge gravite-{{ incident.gravite }}">
                {{ gravites[incident.gravite].nom }}
              </div>
              <div class="incident-etat-badge etat-{{ incident.etat }}">
                {% if incident.etat == 'ouvert' %}
                  <i class="bi bi-circle-fill"></i> Ouvert
                {% elif incident.etat == 'en_cours' %}
                  <i class="bi bi-arrow-repeat"></i> En cours
                {% elif incident.etat == 'resolu' %}
                  <i class="bi bi-check-circle-fill"></i> Résolu
                {% elif incident.etat == 'ignore' %}
                  <i class="bi bi-eye-slash-fill"></i> Ignoré
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Description -->
          <div class="incident-description">
            {{ incident.description }}
          </div>

          <!-- Détails -->
          <div class="incident-details">
            <div class="detail-item">
              <span class="detail-label"><i class="bi bi-speaker-fill"></i> Lecteurs impactés :</span>
              <span class="detail-value">{{ incident.lecteurs_impactes|join(', ') }}</span>
            </div>
            {% if incident.assigne_a %}
            <div class="detail-item">
              <span class="detail-label"><i class="bi bi-person-fill"></i> Assigné à :</span>
              <span class="detail-value">{{ incident.assigne_a }}</span>
            </div>
            {% endif %}
            {% if incident.resolu_le %}
            <div class="detail-item">
              <span class="detail-label"><i class="bi bi-check-circle"></i> Résolu le :</span>
              <span class="detail-value">{{ incident.resolu_le.strftime('%d/%m/%Y %H:%M') }}</span>
            </div>
            {% endif %}
          </div>

          <!-- Actions -->
          <div class="incident-actions">
            <a href="{{ url_for('alertes.alerte_detail', incident_id=incident.id) }}" 
               class="btn-incident-action btn-view">
              <i class="bi bi-eye"></i> Voir détails
            </a>
            {% if incident.etat == 'ouvert' %}
              <button class="btn-incident-action btn-acknowledge" 
                      data-incident-id="{{ incident.id }}"
                      data-action="reconnaitre">
                <i class="bi bi-check"></i> Reconnaître
              </button>
              <button class="btn-incident-action btn-assign" 
                      data-incident-id="{{ incident.id }}"
                      data-action="assigner">
                <i class="bi bi-person-plus"></i> S'assigner
              </button>
            {% elif incident.etat == 'en_cours' %}
              <button class="btn-incident-action btn-resolve" 
                      data-incident-id="{{ incident.id }}"
                      data-action="resoudre">
                <i class="bi bi-check-circle"></i> Résoudre
              </button>
            {% endif %}
            {% if incident.etat != 'ignore' %}
              <button class="btn-incident-action btn-ignore" 
                      data-incident-id="{{ incident.id }}"
                      data-action="ignorer">
                <i class="bi bi-eye-slash"></i> Ignorer
              </button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-state-alertes">
        <div class="empty-icon-alertes">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <h3>Aucun incident</h3>
        <p>Tous les systèmes fonctionnent correctement</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Modal pour résoudre un incident -->
<div class="modal fade" id="resolveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-rythmo">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-check-circle"></i> Résoudre l'incident</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="resolveForm">
          <div class="form-group-rythmo">
            <label class="form-label-rythmo">Commentaire de résolution</label>
            <textarea class="form-control-rythmo" name="commentaire" rows="4" 
                      placeholder="Décrivez les actions effectuées pour résoudre l'incident..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="confirmResolve">Résoudre</button>
      </div>
    </div>
  </div>
</div>

<style>
/* ===== HERO ===== */
.alertes-hero {
  margin-top: 2rem;
  text-align: center;
  padding: 2rem 0;
}
.alertes-hero h1 {
  font-size: 2.8rem;
  font-weight: 800;
  margin-bottom: 0.5rem;
  color: white;
  letter-spacing: -0.02em;
}
.alertes-hero h1 i {
  color: #ffc107;
  margin-right: 0.5rem;
}
.alertes-hero p {
  opacity: 0.85;
  font-size: 1.1rem;
}

/* ===== ACTIONS ===== */
.btn-rythmo-back {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: white;
  font-weight: 600;
  padding: 0.6rem 1.5rem;
  border-radius: 12px;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
}

.btn-rythmo-back:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 255, 255, 0.3);
  color: white;
}

.alertes-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.alertes-badge-critical {
  background: rgba(220, 53, 69, 0.2);
  border: 2px solid rgba(220, 53, 69, 0.5);
  border-radius: 12px;
  padding: 0.75rem 1.5rem;
  color: #ff6b6b;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  animation: pulse-critical 2s infinite;
}

@keyframes pulse-critical {
  0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
  50% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
}

/* ===== STATISTIQUES ===== */
.alertes-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card-alerte {
  background: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(40px);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  padding: 1.5rem;
  display: flex;
  align-items: center;
  gap: 1.25rem;
  transition: all 0.3s ease;
}

.stat-card-alerte:hover {
  transform: translateY(-3px);
  border-color: rgba(255, 193, 7, 0.2);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.stat-card-critical {
  border-color: rgba(220, 53, 69, 0.3);
  background: rgba(220, 53, 69, 0.05);
}

.stat-icon-alerte {
  width: 60px;
  height: 60px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  flex-shrink: 0;
}

.stat-icon-total {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: white;
}

.stat-icon-open {
  background: rgba(255, 193, 7, 0.12);
  border: 1px solid rgba(255, 193, 7, 0.2);
  color: #ffc107;
}

.stat-icon-progress {
  background: rgba(23, 162, 184, 0.12);
  border: 1px solid rgba(23, 162, 184, 0.2);
  color: #17a2b8;
}

.stat-icon-resolved {
  background: rgba(40, 167, 69, 0.12);
  border: 1px solid rgba(40, 167, 69, 0.2);
  color: #28a745;
}

.stat-icon-critical {
  background: rgba(220, 53, 69, 0.12);
  border: 1px solid rgba(220, 53, 69, 0.2);
  color: #dc3545;
}

.stat-value {
  font-size: 2rem;
  font-weight: 800;
  color: white;
  line-height: 1;
  margin-bottom: 0.25rem;
}

.stat-label {
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.7);
  font-weight: 500;
}

/* ===== FILTRES ===== */
.alertes-filters {
  background: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(40px);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 20px;
  padding: 1.5rem 2rem;
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  align-items: flex-end;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  flex: 1;
  min-width: 180px;
}

.filter-label {
  font-weight: 600;
  font-size: 0.9rem;
  color: #ffc107;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filter-select {
  background: rgba(255, 255, 255, 0.1);
  border: 1.5px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  padding: 0.75rem 1rem;
  color: white;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  cursor: pointer;
}

.filter-select:focus {
  background: rgba(255, 255, 255, 0.15);
  border-color: #ffc107;
  outline: none;
  box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.2);
}

.filter-select option {
  background: #1a060c;
  color: white;
}

.btn-filter-reset {
  padding: 0.75rem 1.5rem;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 12px;
  color: rgba(255, 255, 255, 0.8);
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  outline: none;
  white-space: nowrap;
}

.btn-filter-reset:hover {
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.2);
  color: white;
}

/* ===== LISTE DES INCIDENTS ===== */
.incidents-list {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.incident-card {
  background: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(40px);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-left: 4px solid;
  border-radius: 20px;
  padding: 2rem;
  transition: all 0.3s ease;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.incident-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
}

.incident-card.incident-gravite-critique {
  border-left-color: #dc3545;
  background: rgba(220, 53, 69, 0.05);
}

.incident-card.incident-gravite-haute {
  border-left-color: #ff9800;
}

.incident-card.incident-gravite-moyenne {
  border-left-color: #ffc107;
}

.incident-card.incident-gravite-basse {
  border-left-color: #17a2b8;
}

.incident-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1.25rem;
  flex-wrap: wrap;
  gap: 1.5rem;
}

.incident-header-left {
  display: flex;
  gap: 1.25rem;
  align-items: flex-start;
  flex: 1;
}

.incident-type-icon {
  font-size: 2rem;
  flex-shrink: 0;
}

.incident-main-info {
  flex: 1;
}

.incident-titre {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0 0 0.75rem 0;
  color: white;
}

.incident-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  align-items: center;
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.7);
}

.incident-type {
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
}

.meta-separator {
  color: rgba(255, 255, 255, 0.4);
}

.incident-zone, .incident-date {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.incident-zone i, .incident-date i {
  color: #ffc107;
}

.incident-header-right {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  align-items: flex-end;
  flex-shrink: 0;
}

.incident-gravite-badge {
  padding: 0.5rem 1rem;
  border-radius: 10px;
  font-weight: 700;
  font-size: 0.85rem;
  white-space: nowrap;
}

.gravite-critique {
  background: rgba(220, 53, 69, 0.2);
  border: 1px solid rgba(220, 53, 69, 0.4);
  color: #ff6b6b;
}

.gravite-haute {
  background: rgba(255, 152, 0, 0.2);
  border: 1px solid rgba(255, 152, 0, 0.4);
  color: #ffb74d;
}

.gravite-moyenne {
  background: rgba(255, 193, 7, 0.2);
  border: 1px solid rgba(255, 193, 7, 0.4);
  color: #ffc107;
}

.gravite-basse {
  background: rgba(23, 162, 184, 0.2);
  border: 1px solid rgba(23, 162, 184, 0.4);
  color: #4dd0e1;
}

.incident-etat-badge {
  padding: 0.5rem 1rem;
  border-radius: 10px;
  font-weight: 700;
  font-size: 0.85rem;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  white-space: nowrap;
}

.etat-ouvert {
  background: rgba(255, 193, 7, 0.15);
  border: 1px solid rgba(255, 193, 7, 0.3);
  color: #ffc107;
}

.etat-en_cours {
  background: rgba(23, 162, 184, 0.15);
  border: 1px solid rgba(23, 162, 184, 0.3);
  color: #17a2b8;
}

.etat-resolu {
  background: rgba(40, 167, 69, 0.15);
  border: 1px solid rgba(40, 167, 69, 0.3);
  color: #28a745;
}

.etat-ignore {
  background: rgba(108, 117, 125, 0.15);
  border: 1px solid rgba(108, 117, 125, 0.3);
  color: #6c757d;
}

.incident-description {
  color: rgba(255, 255, 255, 0.85);
  font-size: 1rem;
  line-height: 1.6;
  margin-bottom: 1.25rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
}

.incident-details {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
  padding-top: 1.25rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.detail-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
}

.detail-label {
  color: rgba(255, 255, 255, 0.7);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.detail-label i {
  color: #ffc107;
}

.detail-value {
  color: white;
  font-weight: 500;
}

.incident-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  padding-top: 1.25rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-incident-action {
  padding: 0.6rem 1.25rem;
  border-radius: 10px;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  text-decoration: none;
  border: 1.5px solid;
  outline: none;
}

.btn-view {
  background: rgba(255, 193, 7, 0.1);
  border-color: rgba(255, 193, 7, 0.3);
  color: #ffc107;
}

.btn-view:hover {
  background: rgba(255, 193, 7, 0.2);
  border-color: rgba(255, 193, 7, 0.5);
  color: #ffc107;
}

.btn-acknowledge {
  background: rgba(23, 162, 184, 0.1);
  border-color: rgba(23, 162, 184, 0.3);
  color: #17a2b8;
}

.btn-acknowledge:hover {
  background: rgba(23, 162, 184, 0.2);
  border-color: rgba(23, 162, 184, 0.5);
  color: #17a2b8;
}

.btn-assign {
  background: rgba(255, 152, 0, 0.1);
  border-color: rgba(255, 152, 0, 0.3);
  color: #ff9800;
}

.btn-assign:hover {
  background: rgba(255, 152, 0, 0.2);
  border-color: rgba(255, 152, 0, 0.5);
  color: #ff9800;
}

.btn-resolve {
  background: rgba(40, 167, 69, 0.1);
  border-color: rgba(40, 167, 69, 0.3);
  color: #28a745;
}

.btn-resolve:hover {
  background: rgba(40, 167, 69, 0.2);
  border-color: rgba(40, 167, 69, 0.5);
  color: #28a745;
}

.btn-ignore {
  background: rgba(108, 117, 125, 0.1);
  border-color: rgba(108, 117, 125, 0.3);
  color: #6c757d;
}

.btn-ignore:hover {
  background: rgba(108, 117, 125, 0.2);
  border-color: rgba(108, 117, 125, 0.5);
  color: #6c757d;
}

/* État vide */
.empty-state-alertes {
  text-align: center;
  padding: 5rem 2rem;
  background: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  border: 1.5px dashed rgba(40, 167, 69, 0.3);
}

.empty-icon-alertes {
  font-size: 6rem;
  color: rgba(40, 167, 69, 0.5);
  margin-bottom: 1.5rem;
}

.empty-state-alertes h3 {
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.empty-state-alertes p {
  opacity: 0.8;
  margin-bottom: 1rem;
}

/* Modal */
.modal-rythmo {
  background: rgba(26, 6, 12, 0.98);
  backdrop-filter: blur(40px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  color: white;
}

.modal-rythmo .modal-header {
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-rythmo .modal-title {
  color: white;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.modal-rythmo .modal-title i {
  color: #ffc107;
}

.modal-rythmo .modal-body {
  color: white;
}

.modal-rythmo .modal-footer {
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* Responsive */
@media (max-width: 768px) {
  .alertes-hero h1 {
    font-size: 2rem;
  }
  
  .alertes-actions {
    flex-direction: column;
    align-items: stretch;
  }
  
  .incident-header {
    flex-direction: column;
  }
  
  .incident-header-right {
    width: 100%;
    flex-direction: row;
    justify-content: space-between;
  }
  
  .incident-actions {
    flex-direction: column;
  }
  
  .btn-incident-action {
    width: 100%;
    justify-content: center;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Filtres
  document.querySelectorAll('.filter-select').forEach(select => {
    select.addEventListener('change', function() {
      applyFilters();
    });
  });

  // Actions sur les incidents
  document.querySelectorAll('.btn-acknowledge, .btn-assign, .btn-ignore').forEach(btn => {
    btn.addEventListener('click', async function() {
      const incidentId = this.dataset.incidentId;
      const action = this.dataset.action;
      
      try {
        const response = await fetch('{{ url_for("alertes.incident_action") }}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            incident_id: incidentId,
            action: action,
            commentaire: ''
          })
        });

        const data = await response.json();
        if (data.success) {
          alert(data.message);
          setTimeout(() => location.reload(), 1000);
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'action');
      }
    });
  });

  // Résoudre un incident
  document.querySelectorAll('.btn-resolve').forEach(btn => {
    btn.addEventListener('click', function() {
      const incidentId = this.dataset.incidentId;
      const modal = new bootstrap.Modal(document.getElementById('resolveModal'));
      modal.show();
      
      document.getElementById('confirmResolve').onclick = async function() {
        const commentaire = document.querySelector('#resolveForm textarea[name="commentaire"]').value;
        
        try {
          const response = await fetch('{{ url_for("alertes.incident_action") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              incident_id: incidentId,
              action: 'resoudre',
              commentaire: commentaire
            })
          });

          const data = await response.json();
          if (data.success) {
            modal.hide();
            alert(data.message);
            setTimeout(() => location.reload(), 1000);
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur lors de la résolution');
        }
      };
    });
  });

  // Badge critiques
  const criticalCount = {{ stats.critiques }};
  if (criticalCount > 0) {
    document.getElementById('criticalBadge').style.display = 'flex';
    document.getElementById('criticalCount').textContent = criticalCount;
  }
});

function applyFilters() {
  const etat = document.getElementById('filterEtat').value;
  const type = document.getElementById('filterType').value;
  const gravite = document.getElementById('filterGravite').value;
  
  const params = new URLSearchParams();
  if (etat !== 'tous') params.append('etat', etat);
  if (type !== 'tous') params.append('type', type);
  if (gravite !== 'tous') params.append('gravite', gravite);
  
  window.location.href = '{{ url_for("alertes.alertes") }}?' + params.toString();
}

function resetFilters() {
  window.location.href = '{{ url_for("alertes.alertes") }}';
}
</script>

{% endblock %}
